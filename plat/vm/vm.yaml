steps:
  - mkimg: "{{ output }}"
    size: 3048M 
  - mklabel: msdos
    device: "{{ output }}"

  - mkpart: primary
    device: "{{ output }}"
    start: 64MiB
    end: 1024MiB 
    part-tag: root-part
  - mkpart: primary
    device: "{{ output }}"
    start: 1024MIB 
    end: 2048MiB
    part-tag: var-part
  - mkpart: primary
    device: "{{ output }}"
    start: 2048MiB 
    end: 100%
    part-tag: sdcard-part

  - mkfs: ext4
    partition: root-part
  - mkfs: ext4
    partition: var-part
  - mkfs: nilfs2
    partition: sdcard-part

  - mount: root-part
    fs-tag: root-fs

  - mount: var-part
    fs-tag: var-fs
    mount-on: root-fs
    dirname: '/var/'

  - unpack-rootfs: root-fs

  - debootstrap: buster
    mirror: http://localhost:3142/debian
    target: root-fs
    arch: amd64
    variant: minbase
    components:
    - main
    - contrib
    - non-free
    unless: rootfs_unpacked

  - apt: install
    packages:
    - linux-image-amd64
    - nilfs-tools
    - hostapd
    - dhcpcd5
    - tcpdump
    - wireless-tools
    - wpasupplicant
    - festival
    - usbutils
    - nano
    - systemd
    fs-tag: root-fs
    unless: rootfs_unpacked

  - cache-rootfs: root-fs
    options: --exclude=/dev/
    unless: rootfs_unpacked

  - shell: |
      echo "bikeos" > "${ROOT?}/etc/hostname"
      # '..vpJrbBlNzG6' is crypt.crypt('bicycle', '..')
      sed -i 's,root:[^:]*,root:..vpJrbBlNzG6,' "${ROOT?}/etc/shadow"
      # configure filesystems
      mkdir -p "${ROOT?}/media/sdcard"
      install -m 644 -o root -g root /spec/fstab "${ROOT?}/etc/fstab"
      # alert bosd on wlan changes
      install -m 644 -o root -g root /bikeos/95-wlan.rules "${ROOT?}/etc/udev/rules.d"
      # install -m 644 -o root -g root /bikeos/bosd.service "${ROOT?}/etc/systemd/system"
      mkdir -p "${ROOT?}/etc/iptables"
      install -m 644 -o root -g root /spec/rules.v4 "${ROOT?}/etc/iptables/rules.v4"
      install -m 644 -o root -g root /spec/rules.v6 "${ROOT?}/etc/iptables/rules.v6"

    root-fs: root-fs

  - chroot: root-fs
    shell: |
      echo 'deb http://localhost:3142/debian buster main contrib non-free' > /etc/apt/sources.list
      apt-get update

  # needs apt-get update to fetch these
  - apt: install
    packages:
    - firmware-atheros
    - firmware-misc-nonfree
    fs-tag: root-fs

  - grub: bios
    root-fs: root-fs
    root-part: root-part 
    defaults: |
      GRUB_DISABLE_OS_PROBER=true
      GRUB_DISABLE_RECOVERY=true
    cmdline: 'init=/lib/systemd/systemd'

  - shell: |
      apt list grub\* | grep installed | cut -f1 -d'/' | xargs apt remove -y
      rm "${ROOT?}/etc/resolv.conf"
      sed -i "s/\/dev\/mapper\/loop[0-9p]*/\/dev\/sda1/g"  "${ROOT?}/boot/grub/grub.cfg"
    root-fs: root-fs
